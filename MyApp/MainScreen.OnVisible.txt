Reset(Audio_error); Set(PlaySoundError, false);
Reset(Audio_pi); Set(PlaySoundPi, false);
Reset(Audio_success); Set(PlaySoundSuccess, false);

If(
    !MainScreenInitialized
    ,

    UpdateContext({isSplushing: true});
    Sleep.Run(3);
    UpdateContext({isSplushing: false});

    UpdateContext({isLoading: true});

    UpdateContext({isMainMenuOpening: false});
    
    // 初期化処理

    // グローバル変数宣言
    UpdateContext({language: Left(Language(), 2)});
    UpdateContext({
        String_MainMenu_About:
        If(
            !IsBlank(LookUp(Strings, And(Key="MainMenuAbout", Language=language), Value)),
            LookUp(Strings, And(Key="MainMenuAbout", Language=language), Value),
            LookUp(Strings, And(Key="MainMenuAbout", Language=""), Value)
        )
    });
    UpdateContext({
        String_MainMenu_Log:
        If(
            !IsBlank(LookUp(Strings, And(Key="MainMenuLog", Language=language), Value)),
            LookUp(Strings, And(Key="MainMenuLog", Language=language), Value),
            LookUp(Strings, And(Key="MainMenuLog", Language=""), Value)
        )
    });
    UpdateContext({
        String_MainMenu_Setting:
        If(
            !IsBlank(LookUp(Strings, And(Key="MainMenuSetting", Language=language), Value)),
            LookUp(Strings, And(Key="MainMenuSetting", Language=language), Value),
            LookUp(Strings, And(Key="MainMenuSetting", Language=""), Value)
        )
    });

    // ローカル変数宣言
    If(
        IsAppAdministrators,
        UpdateContext({
            MenuItems:Table(
                {Key: "Setting", Icon: Icon.Settings, Text: String_MainMenu_Setting},
                {Key: "About", Icon: Icon.Help, Text: Substitute(String_MainMenu_About, "{}", AppName)},
                {Key: "Log", Icon: Icon.LogJournal, Text: String_MainMenu_Log}
            )
        }),
        UpdateContext({
            MenuItems:Table(
                {Key: "Setting", Icon: Icon.Settings, Text: String_MainMenu_Setting},
                {Key: "About", Icon: Icon.Help, Text: Substitute(String_MainMenu_About, "{}", AppName)}
            )
        })
    );

    // ログ書き込み
    If(DebugMode, Log.Run(
        Text(Now(), UTC),
        LookUp(LogLevels, Name="Debug").Name,
        "Initialization of MainScreen finished.",
        KeySolution,
        KeyApp,
        "",
        "MainScreen.OnVisible",
        ""
    ));

    Set(PlaySoundPi, true);Sleep.Run(1);Set(PlaySoundPi, false);Reset(Audio_pi);

    // ここまで初期化処理
    Set(MainScreenInitialized, true);
);

UpdateContext({isLoading: false});
